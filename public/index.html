<!DOCTYPE html><html><head>
  <meta charset="utf-8" />
  <title>Bedrock Usage Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>body{font-family:system-ui;margin:2rem}table{border-collapse:collapse}
    th,td{padding:.4rem .8rem;border:1px solid #ddd}th{background:#f7f7f7}
    .controls{margin:1rem 0;display:flex;gap:1rem;align-items:center}
    select,button{padding:.5rem;font-size:1rem}
    .status{margin:1rem 0;padding:.5rem;border-radius:4px;font-weight:bold}
    .loading{background:#e3f2fd;color:#1976d2;border:1px solid #bbdefb}
    .success{background:#e8f5e8;color:#2e7d32;border:1px solid #c8e6c8}
    .error{background:#ffebee;color:#c62828;border:1px solid #ffcdd2}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #f3f3f3;
      border-top:2px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
</head><body>
  <h2>Bedrock Usage Dashboard</h2>
  
  <div class="controls">
    <label>Profile: <select id="profile" onchange="loadData()"></select></label>
    <label>Region: <select id="region" onchange="loadData()"></select></label>
    <label>Hours: <select id="hours" onchange="loadData()">
      <option value="1">1h</option>
      <option value="6">6h</option>
      <option value="24" selected>24h</option>
      <option value="168">7d</option>
    </select></label>
    <button onclick="loadData()">Refresh</button>
  </div>
  
  <div id="status" class="status" style="display:none"></div>
  
  <canvas id="bar" height="100"></canvas>
  <h3>Raw numbers</h3><table id="tbl"><thead>
    <tr><th>ModelId</th><th>Input</th><th>Output Ã— 5</th><th>Total</th></tr>
  </thead><tbody></tbody></table>

<script>
let chart;

function showStatus(message, type = 'loading') {
  const status = document.getElementById('status');
  status.className = `status ${type}`;
  status.innerHTML = type === 'loading' ? `<span class="spinner"></span>${message}` : message;
  status.style.display = 'block';
}

function hideStatus() {
  document.getElementById('status').style.display = 'none';
}

async function loadDropdowns() {
  showStatus('Loading AWS profiles and regions...');
  try {
    const [profiles, regions] = await Promise.all([
      fetch("/api/profiles").then(r => r.json()),
      fetch("/api/regions").then(r => r.json())
    ]);
    
    const profileSelect = document.getElementById("profile");
    const regionSelect = document.getElementById("region");
    
    profiles.forEach(p => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = p;
      profileSelect.appendChild(opt);
    });
    
    regions.forEach(r => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = r;
      regionSelect.appendChild(opt);
    });
    
    showStatus('AWS profiles and regions loaded', 'success');
    setTimeout(hideStatus, 2000);
  } catch (err) {
    showStatus(`Error loading dropdowns: ${err.message}`, 'error');
  }
}

async function loadData() {
  const profile = document.getElementById("profile").value;
  const region = document.getElementById("region").value;
  const hours = document.getElementById("hours").value;
  
  if (!profile || !region) return;
  
  showStatus(`Loading Bedrock usage for ${profile} in ${region} (${hours}h)...`);
  
  try {
    const params = new URLSearchParams({ profile, region, hours });
    const data = await fetch(`/api/usage?${params}`).then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      return r.json();
    });
    
    // clear table
    const tbody = document.getElementById("tbl").querySelector("tbody");
    tbody.innerHTML = "";
    
    if (data.length === 0) {
      showStatus(`No usage data found for ${profile} in ${region} (${hours}h)`, 'success');
      const tr = tbody.insertRow();
      const td = tr.insertCell();
      td.colSpan = 4;
      td.textContent = "No usage data found";
      td.style.textAlign = "center";
      td.style.fontStyle = "italic";
      if (chart) chart.destroy();
      return;
    }
    
    // populate table
    data.forEach(r => {
      const tr = tbody.insertRow();
      ["ModelId","input","output_x5","quota_tokens"]
        .forEach(k => tr.insertCell().textContent = r[k].toLocaleString());
    });
    
    // update chart
    if (chart) chart.destroy();
    chart = new Chart(document.getElementById("bar").getContext("2d"), {
      type: "bar",
      data: {
        labels: data.map(r => r.ModelId),
        datasets: [{
          label: `Quota tokens (${hours}h)`,
          data: data.map(r => r.quota_tokens)
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
    
    showStatus(`Loaded ${data.length} models with usage data`, 'success');
    setTimeout(hideStatus, 3000);
  } catch (err) {
    showStatus(`Error loading data: ${err.message}`, 'error');
  }
}

async function main() {
  await loadDropdowns();
  await loadData();
}

main();
</script></body></html>